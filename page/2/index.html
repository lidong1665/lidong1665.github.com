<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|微软雅黑:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="细节决定成败，点滴铸就辉煌">
<meta property="og:type" content="website">
<meta property="og:title" content="小东子的个人技术专栏">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="小东子的个人技术专栏">
<meta property="og:description" content="细节决定成败，点滴铸就辉煌">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小东子的个人技术专栏">
<meta name="twitter:description" content="细节决定成败，点滴铸就辉煌">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title> 小东子的个人技术专栏 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?626475154d06e56c249dfd85a364e659";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60380052";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">小东子的个人技术专栏</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">重点关注Android、Java、智能硬件、JavaEE、react-native，Swift，微信小程序</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/14/Spring-Security-OAuth2-开发指南/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李东">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://avatar.csdn.net/E/A/D/1_u010046908.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="小东子的个人技术专栏">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="小东子的个人技术专栏" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/14/Spring-Security-OAuth2-开发指南/" itemprop="url">
                  Spring Security OAuth2 开发指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-14T08:48:36+08:00">
                2017-03-14
              </time>
            

            

            
          </span>

          
 
         
         <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">5,054(字)</span>
           
         </span>
	  
      <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">18(分)</span>
           
         </span>
          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-官网文档："><a href="#1-官网文档：" class="headerlink" title="1.官网文档："></a>1.官网文档：</h3><p><a href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html" target="_blank" rel="external">http://projects.spring.io/spring-security-oauth/docs/oauth2.html</a></p>
<h3 id="2-Spring-OAuth2-0-提供者实现原理"><a href="#2-Spring-OAuth2-0-提供者实现原理" class="headerlink" title="2. Spring OAuth2.0 提供者实现原理"></a>2. Spring OAuth2.0 提供者实现原理</h3><p>Spring OAuth2.0提供者实际上分为：</p>
<ul>
<li>授权服务 Authorization Service.</li>
<li>资源服务 Resource Service.</li>
</ul>
<p><strong>注意：</strong>虽然这两个提供者有时候可能存在同一个应用程序中，但在Spring Security OAuth中你可以把他它们各自放在不同的应用上，而且你可以有多个资源服务，它们共享同一个中央授权服务。</p>
<p>所有获取令牌的请求都将会在Spring MVC controller endpoints中进行处理，并且访问受保护的资源服务的处理流程将会放在标准的Spring Security请求过滤器中(filters)。</p>
<h4 id="2-1-配置一个授权服务必须要实现的endpoints："><a href="#2-1-配置一个授权服务必须要实现的endpoints：" class="headerlink" title="2.1 配置一个授权服务必须要实现的endpoints："></a>2.1 配置一个授权服务必须要实现的endpoints：</h4><ul>
<li>AuthorizationEndpoint：用来作为请求者获得授权的服务，默认的URL是/oauth/authorize.</li>
<li>TokenEndpoint：用来作为请求者获得令牌（Token）的服务，默认的URL是/oauth/token.</li>
</ul>
<h4 id="2-2-配置一个资源服务必须要实现的过滤器："><a href="#2-2-配置一个资源服务必须要实现的过滤器：" class="headerlink" title="2.2 配置一个资源服务必须要实现的过滤器："></a>2.2 配置一个资源服务必须要实现的过滤器：</h4><ul>
<li>OAuth2AuthenticationProcessingFilter：用来作为认证令牌（Token）的一个处理流程过滤器。只有当过滤器通过之后，请求者才能获得受保护的资源。</li>
</ul>
<p>配置提供者（授权、资源）都可以通过简单的Java注解@Configuration来进行适配或者也可以使用基于XML的声明式语法来进行配置，如果使用XML配置的的话，那么请使用<a href="http://www.springframework.org/schema/security/spring-security-oauth2.xsd来作为XML的schema（即XML概要定义）以及使用http://www.springframework.org/schema/security/oauth2来作为命名空间。" target="_blank" rel="external">http://www.springframework.org/schema/security/spring-security-oauth2.xsd来作为XML的schema（即XML概要定义）以及使用http://www.springframework.org/schema/security/oauth2来作为命名空间。</a></p>
<h3 id="3-授权服务配置"><a href="#3-授权服务配置" class="headerlink" title="3. 授权服务配置"></a>3. 授权服务配置</h3><p>配置一个授权服务，你需要考虑几种授权类型（Grant Type），不同的授权类型为客户端（Client）提供了不同的获取令牌（Token）方式，为了实现并确定这几种授权，需要配置使用 <strong>ClientDetailsService</strong> 和 <strong>TokenService</strong> 来开启或者禁用这几种授权机制。到这里就请注意了，不管你使用什么样的授权类型（Grant Type），每一个客户端（Client）都能够通过明确的配置以及权限来实现不同的授权访问机制。这也就是说，假如你提供了一个支持”client_credentials”的授权方式，并不意味着客户端就需要使用这种方式来获得授权。下面是几种授权类型的列表，具体授权机制的含义可以参见<a href="https://github.com/jeansfish/RFC6749.zh-cn" target="_blank" rel="external">RFC6749(中文版本)</a>：</p>
<ul>
<li>authorization_code：授权码类型。</li>
<li>implicit：隐式授权类型。</li>
<li>password：资源所有者（即用户）密码类型。</li>
<li>client_credentials：客户端凭据（客户端ID以及Key）类型。</li>
<li>refresh_token：通过以上授权获得的刷新令牌来获取新的令牌。</li>
</ul>
<p>可以用 @EnableAuthorizationServer 注解来配置OAuth2.0 授权服务机制，通过使用@Bean注解的几个方法一起来配置这个授权服务。下面咱们介绍几个配置类，这几个配置是由Spring创建的独立的配置对象，它们会被Spring传入AuthorizationServerConfigurer中：</p>
<ul>
<li>ClientDetailsServiceConfigurer：用来配置客户端详情服务（ClientDetailsService），客户端详情信息在这里进行初始化，你能够把客户端详情信息写死在这里或者是通过数据库来存储调取详情信息。</li>
<li>AuthorizationServerSecurityConfigurer：用来配置令牌端点(Token Endpoint)的安全约束.</li>
<li>AuthorizationServerEndpointsConfigurer：用来配置授权（authorization）以及令牌（token）的访问端点和令牌服务(token services)。</li>
</ul>
<p><strong>注意：</strong>以上的配置可以选择继承AuthorizationServerConfigurerAdapter并且覆写其中的三个configure方法来进行配置。）</p>
<p>配置授权服务一个比较重要的方面就是提供一个授权码给一个OAuth客户端（通过 authorization_code 授权类型），一个授权码的获取是OAuth客户端跳转到一个授权页面，然后通过验证授权之后服务器重定向到OAuth客户端，并且在重定向连接中附带返回一个授权码。</p>
<p>如果你是通过XML来进行配置的话，那么可以使用 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;authorization-server/&gt;</div></pre></td></tr></table></figure>
<p> 标签来进行配置。</p>
<h4 id="3-1-配置客户端详情信息（Client-Details-："><a href="#3-1-配置客户端详情信息（Client-Details-：" class="headerlink" title="3.1 配置客户端详情信息（Client Details)："></a>3.1 配置客户端详情信息（Client Details)：</h4><p>ClientDetailsServiceConfigurer (AuthorizationServerConfigurer 的一个回调配置项) 能够使用内存或者JDBC来实现客户端详情服务（ClientDetailsService），有几个重要的属性如下列表：</p>
<ul>
<li>clientId：（必须的）用来标识客户的Id。</li>
<li>secret：（需要值得信任的客户端）客户端安全码，如果有的话。</li>
<li>scope：用来限制客户端的访问范围，如果为空（默认）的话，那么客户端拥有全部的访问范围。</li>
<li>authorizedGrantTypes：此客户端可以使用的授权类型，默认为空。</li>
<li>authorities：此客户端可以使用的权限（基于Spring Security authorities）。</li>
</ul>
<p>客户端详情（Client Details）能够在应用程序运行的时候进行更新，可以通过访问底层的存储服务（例如将客户端详情存储在一个关系数据库的表中，就可以使用 JdbcClientDetailsService）或者通过 ClientDetailsService 接口（同时你也可以实现 ClientDetailsService 接口）来进行管理。</p>
<h4 id="3-2-管理令牌（Managing-Token）："><a href="#3-2-管理令牌（Managing-Token）：" class="headerlink" title="3.2 管理令牌（Managing Token）："></a>3.2 管理令牌（Managing Token）：</h4><p>AuthorizationServerTokenServices 接口定义了一些操作使得你可以对令牌进行一些必要的管理，在使用这些操作的时候请注意以下几点：<br>当一个令牌被创建了，你必须对其进行保存，这样当一个客户端使用这个令牌对资源服务进行请求的时候才能够引用这个令牌。<br>当一个令牌是有效的时候，它可以被用来加载身份信息，里面包含了这个令牌的相关权限。</p>
<p>当你自己创建 AuthorizationServerTokenServices 这个接口的实现时，你可能需要考虑一下使用 DefaultTokenServices 这个类，里面包含了一些有用实现，你可以使用它来修改令牌的格式和令牌的存储。默认的，当它尝试创建一个令牌的时候，是使用随机值来进行填充的，除了持久化令牌是委托一个 TokenStore 接口来实现以外，这个类几乎帮你做了所有的事情。并且 TokenStore 这个接口有一个默认的实现，它就是 InMemoryTokenStore ，如其命名，所有的令牌是被保存在了内存中。除了使用这个类以外，你还可以使用一些其他的预定义实现，下面有几个版本，它们都实现了TokenStore接口：</p>
<ul>
<li><p>InMemoryTokenStore：这个版本的实现是被默认采用的，它可以完美的工作在单服务器上（即访问并发量压力不大的情况下，并且它在失败的时候不会进行备份），大多数的项目都可以使用这个版本的实现来进行尝试，你可以在开发的时候使用它来进行管理，因为不会被保存到磁盘中，所以更易于调试。</p>
</li>
<li><p>JdbcTokenStore：这是一个基于JDBC的实现版本，令牌会被保存进关系型数据库。使用这个版本的实现时，你可以在不同的服务器之间共享令牌信息，使用这个版本的时候请注意把”spring-jdbc”这个依赖加入到你的classpath当中。</p>
</li>
<li><p>JwtTokenStore：这个版本的全称是 JSON Web Token（JWT），它可以把令牌相关的数据进行编码（因此对于后端服务来说，它不需要进行存储，这将是一个重大优势），但是它有一个缺点，那就是撤销一个已经授权令牌将会非常困难，所以它通常用来处理一个生命周期较短的令牌以及撤销刷新令牌（refresh_token）。另外一个缺点就是这个令牌占用的空间会比较大，如果你加入了比较多用户凭证信息。JwtTokenStore 不会保存任何数据，但是它在转换令牌值以及授权信息方面与 DefaultTokenServices 所扮演的角色是一样的。</p>
</li>
</ul>
<h4 id="3-3-JWT令牌（JWT-Tokens）"><a href="#3-3-JWT令牌（JWT-Tokens）" class="headerlink" title="3.3 JWT令牌（JWT Tokens）"></a>3.3 JWT令牌（JWT Tokens）</h4><p>使用JWT令牌你需要在授权服务中使用 JwtTokenStore，资源服务器也需要一个解码的Token令牌的类 JwtAccessTokenConverter，JwtTokenStore依赖这个类来进行编码以及解码，因此你的授权服务以及资源服务都需要使用这个转换类。</p>
<p>Token令牌默认是有签名的，并且资源服务需要验证这个签名，因此呢，你需要使用一个对称的Key值，用来参与签名计算，这个Key值存在于授权服务以及资源服务之中。或者你可以使用非对称加密算法来对Token进行签名，Public Key公布在/oauth/token_key这个URL连接中，默认的访问安全规则是”denyAll()”，即在默认的情况下它是关闭的，你可以注入一个标准的 SpEL 表达式到 AuthorizationServerSecurityConfigurer 这个配置中来将它开启（例如使用”permitAll()”来开启可能比较合适，因为它是一个公共密钥）。</p>
<p>如果你要使用 JwtTokenStore，请务必把”spring-security-jwt”这个依赖加入到你的classpath中。</p>
<h4 id="3-4-配置授权类型（Grant-Types）："><a href="#3-4-配置授权类型（Grant-Types）：" class="headerlink" title="3.4 配置授权类型（Grant Types）："></a>3.4 配置授权类型（Grant Types）：</h4><p>授权是使用 AuthorizationEndpoint 这个端点来进行控制的，你能够使用 AuthorizationServerEndpointsConfigurer 这个对象的实例来进行配置(AuthorizationServerConfigurer 的一个回调配置项，见上的概述) ，如果你不进行设置的话，默认是除了资源所有者密码（password）授权类型以外，支持其余所有标准授权类型的（RFC6749），我们来看一下这个配置对象有哪些属性可以设置吧，如下列表：</p>
<ul>
<li>authenticationManager：认证管理器，当你选择了资源所有者密码（password）授权类型的时候，请设置这个属性注入一个 AuthenticationManager 对象。</li>
<li>userDetailsService：如果啊，你设置了这个属性的话，那说明你有一个自己的 UserDetailsService 接口的实现，或者你可以把这个东西设置到全局域上面去（例如 GlobalAuthenticationManagerConfigurer 这个配置对象），当你设置了这个之后，那么 “refresh_token” 即刷新令牌授权类型模式的流程中就会包含一个检查，用来确保这个账号是否仍然有效，假如说你禁用了这个账户的话。</li>
<li>authorizationCodeServices：这个属性是用来设置授权码服务的（即 AuthorizationCodeServices 的实例对象），主要用于 “authorization_code” 授权码类型模式。</li>
<li>implicitGrantService：这个属性用于设置隐式授权模式，用来管理隐式授权模式的状态。</li>
<li>tokenGranter：这个属性就很牛B了，当你设置了这个东西（即 TokenGranter 接口实现），那么授权将会交由你来完全掌控，并且会忽略掉上面的这几个属性，这个属性一般是用作拓展用途的，即标准的四种授权模式已经满足不了你的需求的时候，才会考虑使用这个。</li>
</ul>
<p>在XML配置中呢，你可以使用 “authorization-server” 这个标签元素来进行设置。</p>
<h4 id="3-5-配置授权端点的URL（Endpoint-URLs）："><a href="#3-5-配置授权端点的URL（Endpoint-URLs）：" class="headerlink" title="3.5 配置授权端点的URL（Endpoint URLs）："></a>3.5 配置授权端点的URL（Endpoint URLs）：</h4><p>AuthorizationServerEndpointsConfigurer 这个配置对象(AuthorizationServerConfigurer 的一个回调配置项，见上的概述) 有一个叫做 pathMapping() 的方法用来配置端点URL链接，它有两个参数：<br>第一个参数：String 类型的，这个端点URL的默认链接。<br>第二个参数：String 类型的，你要进行替代的URL链接。<br>以上的参数都将以 “/“ 字符为开始的字符串，框架的默认URL链接如下列表，可以作为这个 pathMapping() 方法的第一个参数：</p>
<ul>
<li>/oauth/authorize：授权端点。</li>
<li>/oauth/token：令牌端点。</li>
<li>/oauth/confirm_access：用户确认授权提交端点。</li>
<li>/oauth/error：授权服务错误信息端点。</li>
<li>/oauth/check_token：用于资源服务访问的令牌解析端点。</li>
<li>/oauth/token_key：提供公有密匙的端点，如果你使用JWT令牌的话。</li>
</ul>
<p>需要注意的是授权端点这个URL应该被Spring Security保护起来只供授权用户访问，我们来看看在标准的Spring Security中 WebSecurityConfigurer 是怎么用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected void configure(HttpSecurity http) throws Exception &#123;</div><div class="line">    http .authorizeRequests().antMatchers(&quot;/login&quot;).permitAll().and()</div><div class="line">    // default protection for all resources (including /oauth/authorize)</div><div class="line">    .authorizeRequests() .anyRequest().hasRole(&quot;USER&quot;)</div><div class="line">    // ... more configuration, e.g. for form login</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意：如果你的应用程序中既包含授权服务又包含资源服务的话，那么这里实际上是另一个的低优先级的过滤器来控制资源接口的，这些接口是被保护在了一个访问令牌（access token）中，所以请挑选一个URL链接来确保你的资源接口中有一个不需要被保护的链接用来取得授权，就如上面示例中的 /login 链接，你需要在 WebSecurityConfigurer 配置对象中进行设置。</p>
<p>令牌端点默认也是受保护的，不过这里使用的是基于 HTTP Basic Authentication 标准的验证方式来验证客户端的，这在XML配置中是无法进行设置的（所以它应该被明确的保护）。</p>
<p>在XML配置中可以使用 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;authorization-server/&gt;</div></pre></td></tr></table></figure>
<p>元素标签来改变默认的端点URLs，注意在配置 /check_token 这个链接端点的时候，使用 check-token-enabled 属性标记启用。</p>
<h4 id="3-6-强制使用SSL（Enforcing-SSL）："><a href="#3-6-强制使用SSL（Enforcing-SSL）：" class="headerlink" title="3.6 强制使用SSL（Enforcing SSL）："></a>3.6 强制使用SSL（Enforcing SSL）：</h4><p>使用简单的HTTP请求来进行测试是可以的，但是如果你要部署到产品环境上的时候，你应该永远都使用SSL来保护授权服务器在与客户端进行通讯的时候进行加密。你可以把授权服务应用程序放到一个安全的运行容器中，或者你可以使用一个代理，如果你设置正确了的话它们应该工作的很好（这样的话你就不需要设置任何东西了）。<br>但是也许你可能希望使用 Spring Security 的 requiresChannel() 约束来保证安全，对于授权端点来说（还记得上面的列表吗，就是那个 /authorize 端点），它应该成为应用程序安全连接的一部分，而对于 /token 令牌端点来说的话，它应该有一个标记被配置在 AuthorizationServerEndpointsConfigurer 配置对象中，你可以使用 sslOnly() 方法来进行设置。当然了，这两个设置是可选的，不过在以上两种情况中，会导致Spring Security 会把不安全的请求通道重定向到一个安全通道中。（注：即将HTTP请求重定向到HTTPS请求上）。</p>
<h4 id="3-7自定义错误处理（Error-Handling）："><a href="#3-7自定义错误处理（Error-Handling）：" class="headerlink" title="3.7自定义错误处理（Error Handling）："></a>3.7自定义错误处理（Error Handling）：</h4><p>端点实际上就是一个特殊的Controller，它用于返回一些对象数据。<br>授权服务的错误信息是使用标准的Spring MVC来进行处理的，也就是 @ExceptionHandler 注解的端点方法，你也可以提供一个 WebResponseExceptionTranslator 对象。最好的方式是改变响应的内容而不是直接进行渲染。<br>假如说在呈现令牌端点的时候发生了异常，那么异常委托了 HttpMessageConverters 对象（它能够被添加到MVC配置中）来进行输出。假如说在呈现授权端点的时候未通过验证，则会被重定向到 /oauth/error 即错误信息端点中。whitelabel error （即Spring框架提供的一个默认错误页面）错误端点提供了HTML的响应，但是你大概可能需要实现一个自定义错误页面（例如只是简单的增加一个 @Controller 映射到请求路径上 @RequestMapping(“/oauth/error”)）。</p>
<h4 id="3-8-映射用户角色到权限范围（Mapping-User-Roles-to-Scopes）："><a href="#3-8-映射用户角色到权限范围（Mapping-User-Roles-to-Scopes）：" class="headerlink" title="3.8 映射用户角色到权限范围（Mapping User Roles to Scopes）："></a>3.8 映射用户角色到权限范围（Mapping User Roles to Scopes）：</h4><p>有时候限制令牌的权限范围是很有用的，这不仅仅是针对于客户端，你还可以根据用户的权限来进行限制。如果你使用 DefaultOAuth2RequestFactory 来配置 AuthorizationEndpoint 的话你可以设置一个flag即 checkUserScopes=true来限制权限范围，不过这只能匹配到用户的角色。你也可以注入一个 OAuth2RequestFactory 到 TokenEnpoint 中，不过这只能工作在 password 授权模式下。如果你安装一个 TokenEndpointAuthenticationFilter 的话，你只需要增加一个过滤器到 HTTP BasicAuthenticationFilter 后面即可。当然了，你也可以实现你自己的权限规则到 scopes 范围的映射和安装一个你自己版本的 OAuth2RequestFactory。AuthorizationServerEndpointConfigurer 配置对象允许你注入一个你自定义的 OAuth2RequestFactory，因此你可以使用这个特性来设置这个工厂对象，前提是你使用 @EnableAuthorizationServer 注解来进行配置</p>
<h4 id="4-资源服务配置"><a href="#4-资源服务配置" class="headerlink" title="4. 资源服务配置"></a>4. 资源服务配置</h4><p>一个资源服务（可以和授权服务在同一个应用中，当然也可以分离开成为两个不同的应用程序）提供一些受token令牌保护的资源，Spring OAuth提供者是通过Spring Security authentication filter 即验证过滤器来实现的保护，你可以通过 @EnableResourceServer 注解到一个 @Configuration 配置类上，并且必须使用 ResourceServerConfigurer 这个配置对象来进行配置（可以选择继承自 ResourceServerConfigurerAdapter 然后覆写其中的方法，参数就是这个对象的实例），下面是一些可以配置的属性：</p>
<ul>
<li>tokenServices：ResourceServerTokenServices 类的实例，用来实现令牌服务。</li>
<li>resourceId：这个资源服务的ID，这个属性是可选的，但是推荐设置并在授权服务中进行验证。</li>
<li>其他的拓展属性例如 tokenExtractor 令牌提取器用来提取请求中的令牌。</li>
<li>请求匹配器，用来设置需要进行保护的资源路径，默认的情况下是受保护资源服务的全部路径。</li>
<li>受保护资源的访问规则，默认的规则是简单的身份验证（plain authenticated）。</li>
<li>其他的自定义权限保护规则通过 HttpSecurity 来进行配置。</li>
</ul>
<p>@EnableResourceServer 注解自动增加了一个类型为 OAuth2AuthenticationProcessingFilter 的过滤器链，</p>
<p>在XML配置中，使用 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;resource-server /&gt;</div></pre></td></tr></table></figure>
<p>标签元素并指定id为一个servlet过滤器就能够手动增加一个标准的过滤器链。</p>
<p>ResourceServerTokenServices 是组成授权服务的另一半，如果你的授权服务和资源服务在同一个应用程序上的话，你可以使用 DefaultTokenServices ，这样的话，你就不用考虑关于实现所有必要的接口的一致性问题，这通常是很困难的。如果你的资源服务器是分离开的，那么你就必须要确保能够有匹配授权服务提供的 ResourceServerTokenServices，它知道如何对令牌进行解码。<br>在授权服务器上，你通常可以使用 DefaultTokenServices 并且选择一些主要的表达式通过 TokenStore（后端存储或者本地编码）。</p>
<p>RemoteTokenServices 可以作为一个替代，它将允许资源服务器通过HTTP请求来解码令牌（也就是授权服务的 /oauth/check_token 端点）。如果你的资源服务没有太大的访问量的话，那么使用RemoteTokenServices 将会很方便（所有受保护的资源请求都将请求一次授权服务用以检验token值），或者你可以通过缓存来保存每一个token验证的结果。</p>
<p>使用授权服务的 /oauth/check_token 端点你需要将这个端点暴露出去，以便资源服务可以进行访问，这在咱们授权服务配置中已经提到了，下面是一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void configure(AuthorizationServerSecurityConfigurer oauthServer) throws Exception &#123;</div><div class="line">    oauthServer.tokenKeyAccess(&quot;isAnonymous() || hasAuthority(&apos;ROLE_TRUSTED_CLIENT&apos;)&quot;)</div><div class="line">        .checkTokenAccess(&quot;hasAuthority(&apos;ROLE_TRUSTED_CLIENT&apos;)&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个例子中，我们配置了 /oauth/check_token 和 /oauth/token_key 这两个端点（受信任的资源服务能够获取到公有密匙，这是为了验证JWT令牌）。这两个端点使用了HTTP Basic Authentication 即HTTP基本身份验证，使用 client_credentials 授权模式可以做到这一点。</p>
<h4 id="4-1-配置OAuth-Aware表达式处理器（OAuth-Aware-Expression-Handler）："><a href="#4-1-配置OAuth-Aware表达式处理器（OAuth-Aware-Expression-Handler）：" class="headerlink" title="4.1 配置OAuth-Aware表达式处理器（OAuth-Aware Expression Handler）："></a>4.1 配置OAuth-Aware表达式处理器（OAuth-Aware Expression Handler）：</h4><p>你也许希望使用 Spring Security’s expression-based access control 来获得一些优势，一个表达式处理器会被注册到默认的 @EnableResourceServer 配置中，这个表达式包含了 <strong>#oauth2.clientHasRole，#oauth2.clientHasAnyRole</strong> 以及 <strong>#oauth2.denyClient</strong> 所提供的方法来帮助你使用权限角色相关的功能（在 OAuth2SecurityExpressionMethods 中有完整的列表）。<br>在XML配置中你可以注册一个 OAuth-Aware 表达式处理器即 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;expression-handler /&gt;</div></pre></td></tr></table></figure>
<p>元素标签到 常规的 <code>&lt;http /&gt;</code> 安全配置上。</p>
<p> 资料来源：<a href="http://www.cnblogs.com/xingxueliao/p/5911292.html" target="_blank" rel="external">http://www.cnblogs.com/xingxueliao/p/5911292.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/14/jvm知识点总览/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李东">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://avatar.csdn.net/E/A/D/1_u010046908.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="小东子的个人技术专栏">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="小东子的个人技术专栏" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/14/jvm知识点总览/" itemprop="url">
                  jvm知识点总览
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-14T08:44:57+08:00">
                2017-03-14
              </time>
            

            

            
          </span>

          
 
         
         <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">3,716(字)</span>
           
         </span>
	  
      <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">13(分)</span>
           
         </span>
          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载 <strong>作者：纯洁的微笑</strong><br><strong>出处：<a href="http://www.ityouknow.com/java/2017/03/01/jvm-overview.html" target="_blank" rel="external">http://www.ityouknow.com/</a></strong><br>在江湖中要练就绝世武功必须内外兼备，精妙的招式和深厚的内功，武功的基础是内功。对于武功低（就像江南七怪）的人，招式更重要，因为他们不能靠内功直接去伤人，只能靠招式，利刃上优势来取胜了，但是练到高手之后，内功就更主要了。一个内功低的人招式在奇妙也打不过一个内功高的人。比如，你剑法再厉害，一剑刺过来，别人一掌打断你的剑，你还怎么使剑法，你一掌打到一个武功高的人身上，那人没什么事，却把你震伤了，你还怎么打。同样两者也是相辅相成的，内功深厚之后，原来普通的一招一式威力也会倍增。</p>
<p>对于搞开发的我们其实也是一样，现在流行的框架越来越多，封装的也越来越完善，各种框架可以搞定一切，几乎不用关注底层的实现，初级程序员只要熟悉基本的使用方法，便可以快速的开发上线；但对于高级程序员来讲，内功的修炼却越发的重要，比如算法、设计模式、底层原理等，只有把这些基础熟练之后，才能在开发过程中知其然知其所以然，出现问题时能快速定位到问题的本质。</p>
<p>对于Java程序员来讲，spring全家桶几乎可以搞定一切，spring全家桶便是精妙的招式，jvm就是内功心法很重要的一块，线上出现性能问题，jvm调优更是不可回避的问题。因此JVM基础知识对于高级程序员的重要性不必言语，我司在面试高级开发的时候，jvm相关知识也必定是考核的标准之一。本篇文章会根据之前写的jvm系列文章梳理出jvm需要关注的所有考察点。</p>
<h2 id="jvm-总体梳理"><a href="#jvm-总体梳理" class="headerlink" title="jvm 总体梳理"></a>jvm 总体梳理</h2><p>jvm体系总体分四大块：</p>
<ul>
<li>类的加载机制    </li>
<li>jvm内存结构  </li>
<li>GC算法 垃圾回收</li>
<li>GC分析 命令调优</li>
</ul>
<p><em>当然这些知识点在之前的文章中都有详细的介绍，这里只做主干的梳理</em></p>
<p>这里画了一个思维导图，将所有的知识点进行了陈列，因为图比较大可以点击右键下载了放大查看。</p>
<p>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/JVM.jpg" alt=""></p>
<h2 id="类的加载机制"><a href="#类的加载机制" class="headerlink" title="类的加载机制"></a>类的加载机制</h2><p>主要关注点：</p>
<ul>
<li>什么是类的加载  </li>
<li>类的生命周期  </li>
<li>类加载器  </li>
<li>双亲委派模型  </li>
</ul>
<p><strong>什么是类的加载</strong></p>
<p>类的加载指的是将类的.class文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个java.lang.Class对象，用来封装类在方法区内的数据结构。类的加载的最终产品是位于堆区中的Class对象，Class对象封装了类在方法区内的数据结构，并且向Java程序员提供了访问方法区内的数据结构的接口。 </p>
<p><strong>类的生命周期</strong></p>
<p>类的生命周期包括这几个部分，加载、连接、初始化、使用和卸载，其中前三部是类的加载的过程,如下图；</p>
<p>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/class.png" alt=""></p>
<ul>
<li>加载，查找并加载类的二进制数据，在Java堆中也创建一个java.lang.Class类的对象  </li>
<li>连接，连接又包含三块内容：验证、准备、初始化。1）验证，文件格式、元数据、字节码、符号引用验证；2）准备，为类的静态变量分配内存，并将其初始化为默认值；3）解析，把类中的符号引用转换为直接引用  </li>
<li>初始化，为类的静态变量赋予正确的初始值  </li>
<li>使用，new出对象程序中使用   </li>
<li>卸载，执行垃圾回收  </li>
</ul>
<blockquote>
<p> <em>几个小问题？</em><br> <em>1、JVM初始化步骤 ？ 2、类初始化时机 ？3、哪几种情况下，Java虚拟机将结束生命周期？</em><br> <em>答案参考这篇文章<a href="http://www.cnblogs.com/ityouknow/p/5603287.html" target="_blank" rel="external">jvm系列(一):java类的加载机制</a></em></p>
</blockquote>
<p><strong>类加载器</strong></p>
<p>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/calssloader.png" alt=""></p>
<ul>
<li>启动类加载器：Bootstrap ClassLoader，负责加载存放在JDK\jre\lib(JDK代表JDK的安装目录，下同)下，或被-Xbootclasspath参数指定的路径中的，并且能被虚拟机识别的类库  </li>
<li>扩展类加载器：Extension ClassLoader，该加载器由sun.misc.Launcher$ExtClassLoader实现，它负责加载DK\jre\lib\ext目录中，或者由java.ext.dirs系统变量指定的路径中的所有类库（如javax.*开头的类），开发者可以直接使用扩展类加载器。  </li>
<li>应用程序类加载器：Application ClassLoader，该类加载器由sun.misc.Launcher$AppClassLoader来实现，它负责加载用户类路径（ClassPath）所指定的类，开发者可以直接使用该类加载器</li>
</ul>
<p><strong>类加载机制</strong></p>
<ul>
<li>全盘负责，当一个类加载器负责加载某个Class时，该Class所依赖的和引用的其他Class也将由该类加载器负责载入，除非显示使用另外一个类加载器来载入  </li>
<li>父类委托，先让父类加载器试图加载该类，只有在父类加载器无法加载该类时才尝试从自己的类路径中加载该类  </li>
<li>缓存机制，缓存机制将会保证所有加载过的Class都会被缓存，当程序中需要使用某个Class时，类加载器先从缓存区寻找该Class，只有缓存区不存在，系统才会读取该类对应的二进制数据，并将其转换成Class对象，存入缓存区。这就是为什么修改了Class后，必须重启JVM，程序的修改才会生效</li>
</ul>
<h2 id="jvm内存结构"><a href="#jvm内存结构" class="headerlink" title="jvm内存结构"></a>jvm内存结构</h2><p>主要关注点：</p>
<ul>
<li>jvm内存结构都是什么</li>
<li>对象分配规则 </li>
</ul>
<p><strong>jvm内存结构</strong></p>
<p>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/structure.png" alt="">  </p>
<blockquote>
<p>方法区和对是所有线程共享的内存区域；而java栈、本地方法栈和程序员计数器是运行是线程私有的内存区域。</p>
</blockquote>
<ul>
<li>Java堆（Heap）,是Java虚拟机所管理的内存中最大的一块。Java堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。  </li>
<li>方法区（Method Area）,方法区（Method Area）与Java堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。  </li>
<li>程序计数器（Program Counter Register）,程序计数器（Program Counter Register）是一块较小的内存空间，它的作用可以看做是当前线程所执行的字节码的行号指示器。  </li>
<li>JVM栈（JVM Stacks）,与程序计数器一样，Java虚拟机栈（Java Virtual Machine Stacks）也是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法被执行的时候都会同时创建一个栈帧（Stack Frame）用于存储局部变量表、操作栈、动态链接、方法出口等信息。每一个方法被调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。  </li>
<li>本地方法栈（Native Method Stacks）,本地方法栈（Native Method Stacks）与虚拟机栈所发挥的作用是非常相似的，其区别不过是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是为虚拟机使用到的Native方法服务。</li>
</ul>
<p><strong>对象分配规则</strong></p>
<ul>
<li>对象优先分配在Eden区，如果Eden区没有足够的空间时，虚拟机执行一次Minor GC。  </li>
<li>大对象直接进入老年代（大对象是指需要大量连续内存空间的对象）。这样做的目的是避免在Eden区和两个Survivor区之间发生大量的内存拷贝（新生代采用复制算法收集内存）。  </li>
<li>长期存活的对象进入老年代。虚拟机为每个对象定义了一个年龄计数器，如果对象经过了1次Minor GC那么对象会进入Survivor区，之后每经过一次Minor GC那么对象的年龄加1，知道达到阀值对象进入老年区。  </li>
<li>动态判断对象的年龄。如果Survivor区中相同年龄的所有对象大小的总和大于Survivor空间的一半，年龄大于或等于该年龄的对象可以直接进入老年代。  </li>
<li>空间分配担保。每次进行Minor GC时，JVM会计算Survivor区移至老年区的对象的平均大小，如果这个值大于老年区的剩余值大小则进行一次Full GC，如果小于检查HandlePromotionFailure设置，如果true则只进行Monitor GC,如果false则进行Full GC。   </li>
</ul>
<blockquote>
<p><em>如何通过参数来控制个各个内存区域</em><br><em>参考此文章：<a href="http://www.cnblogs.com/ityouknow/p/5610232.html" target="_blank" rel="external">jvm系列(二):JVM内存结构</a></em></p>
</blockquote>
<h2 id="GC算法-垃圾回收"><a href="#GC算法-垃圾回收" class="headerlink" title="GC算法 垃圾回收"></a>GC算法 垃圾回收</h2><p>主要关注点：</p>
<ul>
<li>对象存活判断</li>
<li>GC算法   </li>
<li>垃圾回收器 </li>
</ul>
<p><strong>对象存活判断</strong>  </p>
<p>判断对象是否存活一般有两种方式： </p>
<ul>
<li>引用计数：每个对象有一个引用计数属性，新增一个引用时计数加1，引用释放时计数减1，计数为0时可以回收。此方法简单，无法解决对象相互循环引用的问题。  </li>
<li>可达性分析（Reachability Analysis）：从GC Roots开始向下搜索，搜索所走过的路径称为引用链。当一个对象到GC Roots没有任何引用链相连时，则证明此对象是不可用的，不可达对象。</li>
</ul>
<p><strong>GC算法</strong></p>
<p>GC最基础的算法有三种：标记 -清除算法、复制算法、标记-压缩算法，我们常用的垃圾回收器一般都采用分代收集算法。</p>
<ul>
<li>标记 -清除算法，“标记-清除”（Mark-Sweep）算法，如它的名字一样，算法分为“标记”和“清除”两个阶段：首先标记出所有需要回收的对象，在标记完成后统一回收掉所有被标记的对象。  </li>
<li>复制算法，“复制”（Copying）的收集算法，它将可用内存按容量划分为大小相等的两块，每次只使用其中的一块。当这一块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。  </li>
<li>标记-压缩算法，标记过程仍然与“标记-清除”算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存  </li>
<li>分代收集算法，“分代收集”（Generational Collection）算法，把Java堆分为新生代和老年代，这样就可以根据各个年代的特点采用最适当的收集算法。</li>
</ul>
<p><strong>垃圾回收器</strong></p>
<ul>
<li>Serial收集器，串行收集器是最古老，最稳定以及效率高的收集器，可能会产生较长的停顿，只使用一个线程去回收。  </li>
<li>ParNew收集器，ParNew收集器其实就是Serial收集器的多线程版本。  </li>
<li>Parallel收集器，Parallel Scavenge收集器类似ParNew收集器，Parallel收集器更关注系统的吞吐量。  </li>
<li>Parallel Old 收集器，Parallel Old是Parallel Scavenge收集器的老年代版本，使用多线程和“标记－整理”算法  </li>
<li>CMS收集器，CMS（Concurrent Mark Sweep）收集器是一种以获取最短回收停顿时间为目标的收集器。</li>
<li>G1收集器，G1 (Garbage-First)是一款面向服务器的垃圾收集器,主要针对配备多颗处理器及大容量内存的机器. 以极高概率满足GC停顿时间要求的同时,还具备高吞吐量性能特征  </li>
</ul>
<blockquote>
<p><em>GC算法和垃圾回收器算法图解以及更详细内容参考 <a href="http://www.cnblogs.com/ityouknow/p/5614961.html" target="_blank" rel="external">jvm系列(三):GC算法 垃圾收集器</a></em>  </p>
</blockquote>
<h2 id="GC分析-命令调优"><a href="#GC分析-命令调优" class="headerlink" title="GC分析 命令调优"></a>GC分析 命令调优</h2><p>主要关注点：</p>
<ul>
<li>GC日志分析   </li>
<li>调优命令  </li>
<li>调优工具</li>
</ul>
<p><strong>GC日志分析</strong></p>
<p>摘录GC日志一部分（前部分为年轻代gc回收；后部分为full gc回收）：</p>
<pre><code class="xml">2016-07-05T10:43:18.093+0800: 25.395: [GC [PSYoungGen: 274931K-&gt;10738K(274944K)] 371093K-&gt;147186K(450048K), 0.0668480 secs] [Times: user=0.17 sys=0.08, real=0.07 secs] 
2016-07-05T10:43:18.160+0800: 25.462: [Full GC [PSYoungGen: 10738K-&gt;0K(274944K)] [ParOldGen: 136447K-&gt;140379K(302592K)] 147186K-&gt;140379K(577536K) [PSPermGen: 85411K-&gt;85376K(171008K)], 0.6763541 secs] [Times: user=1.75 sys=0.02, real=0.68 secs]
</code></pre>
<p>通过上面日志分析得出，PSYoungGen、ParOldGen、PSPermGen属于Parallel收集器。其中PSYoungGen表示gc回收前后年轻代的内存变化；ParOldGen表示gc回收前后老年代的内存变化；PSPermGen表示gc回收前后永久区的内存变化。young gc 主要是针对年轻代进行内存回收比较频繁，耗时短；full gc 会对整个堆内存进行回城，耗时长，因此一般尽量减少full gc的次数</p>
<p>young gc 日志:<br>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/yong.jpg" alt="">  </p>
<p>Full GC日志:<br>{:.center}<br><img src="http://www.ityouknow.com/assets/images/2017/jvm/full.jpg" alt="">  </p>
<p><strong>调优命令</strong>  </p>
<p>Sun JDK监控和故障处理命令有jps jstat jmap jhat jstack jinfo</p>
<ul>
<li>jps，JVM Process Status Tool,显示指定系统内所有的HotSpot虚拟机进程。  </li>
<li>jstat，JVM statistics Monitoring是用于监视虚拟机运行时状态信息的命令，它可以显示出虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据。  </li>
<li>jmap，JVM Memory Map命令用于生成heap dump文件  </li>
<li>jhat，JVM Heap Analysis Tool命令是与jmap搭配使用，用来分析jmap生成的dump，jhat内置了一个微型的HTTP/HTML服务器，生成dump的分析结果后，可以在浏览器中查看   </li>
<li>jstack，用于生成java虚拟机当前时刻的线程快照。</li>
<li>jinfo，JVM Configuration info 这个命令作用是实时查看和调整虚拟机运行参数。</li>
</ul>
<blockquote>
<p> <em>详细的命令使用参考这里<a href="http://www.ityouknow.com/java/2016/01/01/jvm%E8%B0%83%E4%BC%98-%E5%91%BD%E4%BB%A4%E7%AF%87.html" target="_blank" rel="external">jvm系列(四):jvm调优-命令篇</a></em></p>
</blockquote>
<p><strong>调优工具</strong>  </p>
<p>常用调优工具分为两类,jdk自带监控工具：jconsole和jvisualvm，第三方有：MAT(Memory Analyzer Tool)、GChisto。</p>
<ul>
<li>jconsole，Java Monitoring and Management Console是从java5开始，在JDK中自带的java监控和管理控制台，用于对JVM中内存，线程和类等的监控  </li>
<li>jvisualvm，jdk自带全能工具，可以分析内存快照、线程快照；监控内存变化、GC变化等。  </li>
<li>MAT，Memory Analyzer Tool，一个基于Eclipse的内存分析工具，是一个快速、功能丰富的Java heap分析工具，它可以帮助我们查找内存泄漏和减少内存消耗  </li>
<li>GChisto，一款专业分析gc日志的工具  </li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/27/Java并发编程：Callable、Future和FutureTask/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李东">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://avatar.csdn.net/E/A/D/1_u010046908.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="小东子的个人技术专栏">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="小东子的个人技术专栏" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/27/Java并发编程：Callable、Future和FutureTask/" itemprop="url">
                  Java并发编程：Callable、Future和FutureTask
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-27T12:38:27+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
 
         
         <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">1,475(字)</span>
           
         </span>
	  
      <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">7(分)</span>
           
         </span>
          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><p>在Java中创建线程的2种方式，一种是直接继承Thread，另外一种就是实现Runnable接口。这2种方式都有一个缺陷就是：在执行完任务之后无法获取执行结果。</p>
<h3 id="2、需求"><a href="#2、需求" class="headerlink" title="2、需求"></a>2、需求</h3><p>在Java中，如果需要获取执行结果，就必须通过共享变量或者使用线程通信的方式来达到效果，这样使用起来就比较麻烦。而自从Java 1.5开始，就提供了Callable和Future，通过它们可以在任务执行完毕之后得到任务执行结果。</p>
<h3 id="3、Callable、FutureTask简介"><a href="#3、Callable、FutureTask简介" class="headerlink" title="3、Callable、FutureTask简介"></a>3、Callable、FutureTask简介</h3><p>在学习Callable和FutureTask之前，我们先看一下java.lang.Runnable吧，它是一个接口，在它里面只声明了一个run()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Runnable &#123;</div><div class="line">    /**</div><div class="line">     * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used</div><div class="line">     * to create a thread, starting the thread causes the object&apos;s</div><div class="line">     * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing</div><div class="line">     * thread.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may</div><div class="line">     * take any action whatsoever.</div><div class="line">     *</div><div class="line">     * @see     java.lang.Thread#run()</div><div class="line">     */</div><div class="line">    public abstract void run();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于run()方法返回值为void类型，所以在执行完任务之后无法返回任何结果。</p>
<p>Callable位于java.util.concurrent包下，它也是一个接口，在它里面也只声明了一个方法，只不过这个方法叫做call()：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">package java.util.concurrent;</div><div class="line"></div><div class="line">/**</div><div class="line"> * A task that returns a result and may throw an exception.</div><div class="line"> * Implementors define a single method with no arguments called</div><div class="line"> * &#123;@code call&#125;.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;The &#123;@code Callable&#125; interface is similar to &#123;@link</div><div class="line"> * java.lang.Runnable&#125;, in that both are designed for classes whose</div><div class="line"> * instances are potentially executed by another thread.  A</div><div class="line"> * &#123;@code Runnable&#125;, however, does not return a result and cannot</div><div class="line"> * throw a checked exception.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;The &#123;@link Executors&#125; class contains utility methods to</div><div class="line"> * convert from other common forms to &#123;@code Callable&#125; classes.</div><div class="line"> *</div><div class="line"> * @see Executor</div><div class="line"> * @since 1.5</div><div class="line"> * @author Doug Lea</div><div class="line"> * @param &lt;V&gt; the result type of method &#123;@code call&#125;</div><div class="line"> */</div><div class="line">@FunctionalInterface</div><div class="line">public interface Callable&lt;V&gt; &#123;</div><div class="line">    /**</div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * @return computed result</div><div class="line">     * @throws Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    V call() throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，这是一个泛型接口，call()函数返回的类型就是传递进来的V类型。</p>
<p>那么怎么使用Callable呢？一般情况下是配合ExecutorService来使用的，在ExecutorService接口中声明了若干个submit方法的重载版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</div><div class="line">&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</div><div class="line">Future&lt;?&gt; submit(Runnable task);</div></pre></td></tr></table></figure>
<ul>
<li>第一个submit方法里面的参数类型就是Callable。</li>
<li>Callable一般是和ExecutorService配合来使用的，具体的使用方法讲在后面讲述。</li>
<li>一般情况下我们使用第一个submit方法和第三个submit方法，第二个submit方法很少使用。</li>
<li>Future就是对于具体的Runnable或者Callable任务的执行结果进行取消、查询是否完成、获取结果。必要时可以通过get方法获取执行结果，该方法会阻塞直到任务返回结果。</li>
</ul>
<p>Future类位于java.util.concurrent包下，它是一个接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public  interface  Future&lt;V&gt; &#123;</div><div class="line">     boolean  cancel( boolean  mayInterruptIfRunning);</div><div class="line">     boolean  isCancelled();</div><div class="line">     boolean  isDone();</div><div class="line">     V get()  throws  InterruptedException, ExecutionException;</div><div class="line">     V get( long  timeout, TimeUnit unit)</div><div class="line">         throws  InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Future接口中声明了5个方法，下面依次解释每个方法的作用：</p>
<ul>
<li>cancel方法用来取消任务，如果取消任务成功则返回true，如果取消任务失败则返回false。参数mayInterruptIfRunning表示是否允许取消正在执行却没有执行完毕的任务，如果设置true，则表示可以取消正在执行过程中的任务。如果任务已经完成，则无论mayInterruptIfRunning为true还是false，此方法肯定返回false，即如果取消已经完成的任务会返回false；如果任务正在执行，若mayInterruptIfRunning设置为true，则返回true，若mayInterruptIfRunning设置为false，则返回false；如果任务还没有执行，则无论mayInterruptIfRunning为true还是false，肯定返回true。</li>
<li>isCancelled方法表示任务是否被取消成功，如果在任务正常完成前被取消成功，则返回 true。</li>
<li>isDone方法表示任务是否已经完成，若任务完成，则返回true；</li>
<li>get()方法用来获取执行结果，这个方法会产生阻塞，会一直等到任务执行完毕才返回；</li>
<li>get(long timeout, TimeUnit unit)用来获取执行结果，如果在指定时间内，还没获取到结果，就直接返回null。</li>
</ul>
<p>Future提供了三种功能：</p>
<ol>
<li>判断任务是否完成；</li>
<li>能够中断任务；</li>
<li>能够获取任务执行结果。</li>
</ol>
<p>因为Future只是一个接口，所以是无法直接用来创建对象使用的，因此就有了下面的FutureTask。</p>
<p>###4、Callable、FutureTask使用</p>
<h4 id="4-1简单使用"><a href="#4-1简单使用" class="headerlink" title="4.1简单使用"></a>4.1简单使用</h4><p>CallableTask.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class CallableTask implements Callable&lt;Integer&gt; &#123;</div><div class="line"></div><div class="line">	    @Override</div><div class="line">        public Integer call() throws Exception &#123;</div><div class="line">	    	int hours=5;</div><div class="line">	    	int amount = 0;</div><div class="line">	        while(hours&gt;0)&#123;</div><div class="line">	            System.out.println(&quot;我正在工作,剩余时间 &quot;+hours+&quot;小时&quot;);</div><div class="line">	            amount++;</div><div class="line">	            hours--;</div><div class="line">	            Thread.sleep(1000);</div><div class="line">	        &#125;</div><div class="line">	        return amount;</div><div class="line">	    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TestDemo.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class TestDemo &#123;</div><div class="line">        </div><div class="line">    public static void main(String args[]) throws ExecutionException &#123;</div><div class="line">        CallableTask worker = new CallableTask();</div><div class="line">        FutureTask&lt;Integer&gt; jiangong = new FutureTask&lt;Integer&gt;(worker);</div><div class="line">        new Thread(jiangong).start();</div><div class="line">        </div><div class="line">        while(!jiangong.isDone())&#123;</div><div class="line">            try &#123;</div><div class="line">                System.out.println(&quot;获取结果&quot;+jiangong.get());</div><div class="line">                System.out.println(&quot;任务是否取消&quot;+jiangong.isCancelled());</div><div class="line">                System.out.println(&quot;任务是否执行&quot;+jiangong.isDone());</div><div class="line">                Thread.sleep(1000);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        int amount;</div><div class="line">        try &#123;</div><div class="line">            amount = jiangong.get();</div><div class="line">            System.out.println(&quot;工作做完了,上交了&quot;+amount);</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (ExecutionException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行的结果：</p>
<p><img src="http://img.blog.csdn.net/20170221165451621?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDA0NjkwOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="4-2并发的实现"><a href="#4-2并发的实现" class="headerlink" title="4.2并发的实现"></a>4.2并发的实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package com.lidong.demo;</div><div class="line"></div><div class="line">import java.util.concurrent.Callable;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @项目名称:lidong-dubbo</div><div class="line"> * @类名:Task</div><div class="line"> * @类的描述:</div><div class="line"> * @作者:lidong</div><div class="line"> * @创建时间:2017/2/21 下午3:42</div><div class="line"> * @公司:chni</div><div class="line"> * @QQ:1561281670</div><div class="line"> * @邮箱:lidong1665@163.com</div><div class="line"> */</div><div class="line">public class Task implements Callable&lt;Integer&gt; &#123;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Integer call() throws Exception &#123;</div><div class="line">        System.out.println(Thread.currentThread().getName()+&quot;   子线程在进行计算开始&quot;);</div><div class="line">        Thread.sleep(3000);</div><div class="line">        int sum = 0;</div><div class="line">        for(int i=0;i&lt;100;i++)</div><div class="line">            sum += i;</div><div class="line">        System.out.println(Thread.currentThread().getName()+&quot;   子线程在进行计算结束&quot;);</div><div class="line">        return sum;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Test.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">package com.lidong.demo;</div><div class="line"></div><div class="line">import java.util.concurrent.*;</div><div class="line"></div><div class="line">public class Test &#123;</div><div class="line"></div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line"></div><div class="line">        ExecutorService executor = Executors.newCachedThreadPool();</div><div class="line">        Task task = new Task();</div><div class="line">        FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;Integer&gt;(task);</div><div class="line">        executor.submit(futureTask);</div><div class="line">        executor.shutdown();</div><div class="line">        </div><div class="line">        System.out.println(Thread.currentThread().getName()+&quot;  主线程在执行任务&quot;);</div><div class="line">         </div><div class="line">        try &#123;</div><div class="line">            System.out.println(Thread.currentThread().getName()+ &quot;  task运行结果&quot;+futureTask.get());</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (ExecutionException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">         </div><div class="line">        System.out.println(Thread.currentThread().getName()+  &quot;  所有任务执行完毕&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果：</p>
<p><img src="http://img.blog.csdn.net/20170221165820071?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDA0NjkwOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/27/第一个-spring-Boot-应用通过Docker-来实现构建、运行、发布/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李东">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://avatar.csdn.net/E/A/D/1_u010046908.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="小东子的个人技术专栏">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="小东子的个人技术专栏" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/27/第一个-spring-Boot-应用通过Docker-来实现构建、运行、发布/" itemprop="url">
                  第一个 spring Boot 应用通过Docker 来实现构建、运行、发布
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-27T12:37:34+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
 
         
         <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">1,226(字)</span>
           
         </span>
	  
      <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">6(分)</span>
           
         </span>
          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-Docker-简介"><a href="#1-Docker-简介" class="headerlink" title="1. Docker 简介"></a>1. Docker 简介</h3><p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。Docker image 是用于运行容器化进程的方案，在本文中，我们将构建一个简单的 Spring Boot 应用程序。</p>
<h3 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2.环境搭建"></a>2.环境搭建</h3><ul>
<li>JDK 1.8+</li>
<li>Maven 3.0+</li>
<li>Docker 最新版。<h3 id="3-用-Maven-构建项目"><a href="#3-用-Maven-构建项目" class="headerlink" title="3.用 Maven 构建项目"></a>3.用 Maven 构建项目</h3><h4 id="3-1-创建目录结构"><a href="#3-1-创建目录结构" class="headerlink" title="3.1 创建目录结构"></a>3.1 创建目录结构</h4></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p src/main/java/com/lidong/demo</div></pre></td></tr></table></figure>
<p>在linux或者mac系统中。<br><img src="http://img.blog.csdn.net/20170220095220622?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDA0NjkwOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="3-2-创建-pom-xml-文件"><a href="#3-2-创建-pom-xml-文件" class="headerlink" title="3.2 创建 pom.xml 文件"></a>3.2 创建 pom.xml 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</div><div class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line"></div><div class="line">    &lt;groupId&gt;com.lidong.demo&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;lidong-spring-boot-demo&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</div><div class="line">    &lt;parent&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;1.5.1.RELEASE&lt;/version&gt;</div><div class="line">        &lt;relativePath/&gt;</div><div class="line">    &lt;/parent&gt;</div><div class="line">    &lt;properties&gt;</div><div class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</div><div class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</div><div class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</div><div class="line">        &lt;docker.image.prefix&gt;springio&lt;/docker.image.prefix&gt;</div><div class="line">    &lt;/properties&gt;</div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line"></div><div class="line">    &lt;build&gt;</div><div class="line">        &lt;plugins&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line"></div><div class="line"></div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;com.spotify&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;0.4.13&lt;/version&gt;</div><div class="line">                &lt;configuration&gt;</div><div class="line">                    &lt;imageName&gt;$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt;</div><div class="line">                    &lt;dockerDirectory&gt;src/main/docker&lt;/dockerDirectory&gt;</div><div class="line">                    &lt;resources&gt;</div><div class="line">                        &lt;resource&gt;</div><div class="line">                            &lt;targetPath&gt;/&lt;/targetPath&gt;</div><div class="line">                            &lt;directory&gt;$&#123;project.build.directory&#125;&lt;/directory&gt;</div><div class="line">                            &lt;include&gt;$&#123;project.build.finalName&#125;.jar&lt;/include&gt;</div><div class="line">                        &lt;/resource&gt;</div><div class="line">                    &lt;/resources&gt;</div><div class="line">                &lt;/configuration&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line">        &lt;/plugins&gt;</div><div class="line">    &lt;/build&gt;</div><div class="line"></div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>Spring Boot Maven plugin 提供了很多方便的功能：<br>1）它收集的类路径上所有 jar 文件，并构建成一个单一的、可运行的jar，这使得它更方便地执行和传输服务。<br>2）它搜索的 public static void main() 方法来标记为可运行的类。<br>3）它提供了一个内置的依赖解析器，用于设置版本号以匹配 Spring Boot 的依赖。您可以覆盖任何你想要的版本，但它会默认选择的 Boot 的版本集。</li>
</ol>
<ol>
<li>Spotify 的 docker-maven-plugin 插件是用于构建 Maven 的 Docker Image<br>1）imageName指定了镜像的名字，本例为 springio/lidong-spring-boot-demo<br>2）dockerDirectory指定 Dockerfile 的位置<br>3）resources是指那些需要和 Dockerfile 放在一起，在构建镜像时使用的文件，一般应用 jar 包需要纳入。</li>
</ol>
<h4 id="4-编写-第一个Spring-Boot-应用"><a href="#4-编写-第一个Spring-Boot-应用" class="headerlink" title="4.编写 第一个Spring Boot 应用"></a>4.编写 第一个Spring Boot 应用</h4><p>编写一个简单的 Spring Boot 应用 ：</p>
<p>src/main/java/com/lidong/demo/SampleController.java:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">package com.lidong.demo;</div><div class="line"></div><div class="line">import org.springframework.boot.SpringApplication;</div><div class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line">import org.springframework.stereotype.Controller;</div><div class="line">import org.springframework.web.bind.annotation.RequestMapping;</div><div class="line">import org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @项目名称:lidong-dubbo</div><div class="line"> * @类名:SampleController</div><div class="line"> * @类的描述:</div><div class="line"> * @作者:lidong</div><div class="line"> * @创建时间:2017/2/19 上午9:34</div><div class="line"> * @公司:chni</div><div class="line"> * @QQ:1561281670</div><div class="line"> * @邮箱:lidong1665@163.com</div><div class="line"> */</div><div class="line">@Controller</div><div class="line">@SpringBootApplication</div><div class="line">public class SampleController &#123;</div><div class="line"></div><div class="line">    @ResponseBody</div><div class="line">    @RequestMapping(value = &quot;/&quot;)</div><div class="line">    String home()&#123;</div><div class="line">        return &quot;Hello Docker World&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        SpringApplication.run(SampleController.class,&quot;--server.port=8081&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>类用 @SpringBootApplication @RestController 标识,可用 Spring MVC 来处理 Web 请求。</li>
<li>@RequestMapping 将 / 映射到 home() ，并将”Hello Docker World” 文本作为响应。</li>
<li>main() 方法使用 Spring Boot 的 SpringApplication.run() 方法来启动应用。<h3 id="5-运行程序"><a href="#5-运行程序" class="headerlink" title="5.运行程序"></a>5.运行程序</h3></li>
</ul>
<p>#####5.1使用Maven命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package</div></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar target/lidong-spring-boot-demo-1.0-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>访问项目</p>
<p>如果程序正确运行，浏览器访问 <a href="http://localhost:8081/，可以看到页面" target="_blank" rel="external">http://localhost:8081/，可以看到页面</a> “Hello Docker World.” 字样。</p>
<h5 id="5-2-使用IDEA-插件"><a href="#5-2-使用IDEA-插件" class="headerlink" title="5.2 使用IDEA 插件"></a>5.2 使用IDEA 插件</h5><p><img src="http://img.blog.csdn.net/20170220100454956?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDA0NjkwOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="6-将项目容器化"><a href="#6-将项目容器化" class="headerlink" title="6.将项目容器化"></a>6.将项目容器化</h4><p>Docker 使用 Dockerfile 文件格式来指定 image 层，</p>
<p>创建文件 src/main/docker/Dockerfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">FROM frolvlad/alpine-oraclejdk8:slim</div><div class="line">VOLUME /tmp</div><div class="line">ADD lidong-spring-boot-demo-1.0-SNAPSHOT.jar app.jar</div><div class="line">RUN sh -c &apos;touch /app.jar&apos;</div><div class="line">ENV JAVA_OPTS=&quot;&quot;</div><div class="line">ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar&quot; ]</div></pre></td></tr></table></figure>
<p>解释下这个配置文件：</p>
<p>VOLUME 指定了临时文件目录为/tmp。其效果是在主机 /var/lib/docker 目录下创建了一个临时文件，并链接到容器的/tmp。改步骤是可选的，如果涉及到文件系统的应用就很有必要了。/tmp目录用来持久化到 Docker 数据文件夹，因为 Spring Boot 使用的内嵌 Tomcat 容器默认使用/tmp作为工作目录<br>项目的 jar 文件作为 “app.jar” 添加到容器的<br>ENTRYPOINT 执行项目 app.jar。为了缩短 Tomcat 启动时间，添加一个系统属性指向 “/dev/urandom” 作为 Entropy Source<br>构建 Docker Image</p>
<p>执行构建成为 docker image:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package docker:build</div></pre></td></tr></table></figure>
<p>运行</p>
<p>运行 Docker Image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -p 8081:8081 -t springio/lidong-spring-boot-demo</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20170220101315389?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDA0NjkwOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>看到这个Spring的图标。就以为这我们在docker 上发布Spring boot 程序已经完成。</p>
<p>接下来去访问在浏览器访问 <a href="http://localhost:8081/，可以看到页面" target="_blank" rel="external">http://localhost:8081/，可以看到页面</a> “Hello Docker World.” 字样。</p>
<p>参考资料：<br><a href="http://spring.io/guides/gs/spring-boot-docker/" target="_blank" rel="external">http://spring.io/guides/gs/spring-boot-docker/</a></p>
<p>在这里是一个简单的spring boot的入门。后面会详细介绍Spring-boot 构建微服务一些具体的知识。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/27/dubbo2-5-spring4-mybastis3-2-springmvc4-mongodb3-4-redis3-2整合（十二）之-spring中RabbitMQ延迟队列的实现/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李东">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://avatar.csdn.net/E/A/D/1_u010046908.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="小东子的个人技术专栏">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="小东子的个人技术专栏" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/27/dubbo2-5-spring4-mybastis3-2-springmvc4-mongodb3-4-redis3-2整合（十二）之-spring中RabbitMQ延迟队列的实现/" itemprop="url">
                  dubbo2.5-spring4-mybastis3.2-springmvc4-mongodb3.4-redis3.2整合（十二）之 spring中RabbitMQ延迟队列的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-27T12:36:51+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
 
         
         <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">字数统计:</span>
           <span class="post-count">1,344(字)</span>
           
         </span>
	  
      <span class="post-time">
	   &nbsp; | &nbsp;
           <span class="post-meta-item-icon">
             <i class="fa fa-calendar-o"></i>
           </span>
           <span class="post-meta-item-text">阅读时长:</span>
           <span class="post-count">6(分)</span>
           
         </span>
          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在前面写过一篇<a href="http://blog.csdn.net/u010046908/article/details/56015388" target="_blank" rel="external">dubbo2.5-spring4-mybastis3.2-springmvc4-mongodb3.4-redis3.2整合（七）RabbitMQ工作原理和Spring的集成</a><br>，今天在进一步使用一下RabbitMQ的延迟队列的实现。</p>
<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>RabbitMQ如何实现延迟队列：延迟队列存储的对象肯定是对应的延迟消息，所谓”延迟消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。</p>
<h3 id="2-RabbitMQ的延迟队列使用场景"><a href="#2-RabbitMQ的延迟队列使用场景" class="headerlink" title="2. RabbitMQ的延迟队列使用场景"></a>2. RabbitMQ的延迟队列使用场景</h3><p>场景一：在订单系统中，一个用户下单之后通常有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行一场处理。这是就可以使用延迟队列将订单信息发送到延迟队列。</p>
<p>场景二：用户希望通过手机远程遥控家里的智能设备在指定的时间进行工作。这时候就可以将用户指令发送到延迟队列，当指令设定的时间到了再将指令推送到只能设备。</p>
<h3 id="3-RabbitMQ实现延迟队列"><a href="#3-RabbitMQ实现延迟队列" class="headerlink" title="3.RabbitMQ实现延迟队列"></a>3.RabbitMQ实现延迟队列</h3><p>AMQP协议，以及RabbitMQ本身没有直接支持延迟队列的功能，但是可以通过TTL和DLX模拟出延迟队列的功能。</p>
<h4 id="3-1-TTL（Time-To-Live）"><a href="#3-1-TTL（Time-To-Live）" class="headerlink" title="3.1 TTL（Time To Live）"></a>3.1 TTL（Time To Live）</h4><p>RabbitMQ可以针对Queue和Message设置 x-message-tt，来控制消息的生存时间，如果超时，则消息变为dead letter<br>RabbitMQ针对队列中的消息过期时间有两种方法可以设置。</p>
<ol>
<li>通过队列属性设置，队列中所有消息都有相同的过期时间。 </li>
<li>对消息进行单独设置，每条消息TTL可以不同。</li>
</ol>
<p>如果同时使用，则消息的过期时间以两者之间TTL较小的那个数值为准。消息在队列的生存时间一旦超过设置的TTL值，就成为dead letter</p>
<p>详细可以参考：RabbitMQ之TTL（Time-To-Live 过期时间）</p>
<h4 id="3-2-DLX-Dead-Letter-Exchange"><a href="#3-2-DLX-Dead-Letter-Exchange" class="headerlink" title="3.2 DLX (Dead-Letter-Exchange)"></a>3.2 DLX (Dead-Letter-Exchange)</h4><p>RabbitMQ的Queue可以配置x-dead-letter-exchange 和x-dead-letter-routing-key（可选）两个参数，如果队列内出现了dead letter，则按照这两个参数重新路由。</p>
<p>x-dead-letter-exchange：出现dead letter之后将dead letter重新发送到指定exchange x-dead-letter-routing-key：指定routing-key发送队列出现dead letter的情况有：消息或者队列的TTL过期 队列达到最大长度 消息被消费端拒绝（basic.reject or basic.nack）并且requeue=false，利DLX，当消息在一个队列中变成死信后，它能被重新publish到另一个Exchange。这时候消息就可以重新被消费。</p>
<h3 id="4-案例的实现"><a href="#4-案例的实现" class="headerlink" title="4.案例的实现"></a>4.案例的实现</h3><h4 id="4-1-rabbit-properties"><a href="#4-1-rabbit-properties" class="headerlink" title="4.1 rabbit.properties"></a>4.1 rabbit.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rabbit_username=lidong1665</div><div class="line">rabbit_password=123456</div><div class="line">rabbit_host=192.168.0.107</div><div class="line">rabbit_port=5672</div></pre></td></tr></table></figure>
<h4 id="4-2-spring-rabbitmq-xml"><a href="#4-2-spring-rabbitmq-xml" class="headerlink" title="4.2 spring-rabbitmq.xml"></a>4.2 spring-rabbitmq.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:rabbit=&quot;http://www.springframework.org/schema/rabbit&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</div><div class="line">     http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">     http://www.springframework.org/schema/beans</div><div class="line">     http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">     http://www.springframework.org/schema/rabbit</div><div class="line">     http://www.springframework.org/schema/rabbit/spring-rabbit-1.7.xsd&quot;&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;!--配置connection-factory，指定连接rabbit server参数 --&gt;</div><div class="line">    &lt;rabbit:connection-factory id=&quot;rabbitConnectionFactory&quot;</div><div class="line">                               username=&quot;$&#123;rabbit_username&#125;&quot;</div><div class="line">                               password=&quot;$&#123;rabbit_password&#125;&quot;</div><div class="line">                               host=&quot;$&#123;rabbit_host&#125;&quot;</div><div class="line">                               port=&quot;$&#123;rabbit_port&#125;&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;!--通过指定下面的admin信息，当前producer中的exchange和queue会在rabbitmq服务器上自动生成 --&gt;</div><div class="line">    &lt;rabbit:admin id=&quot;connectAdmin&quot; connection-factory=&quot;rabbitConnectionFactory&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;taskExecutor&quot; class=&quot;org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor&quot;&gt;</div><div class="line">        &lt;property name=&quot;corePoolSize&quot; value=&quot;3&quot;/&gt;</div><div class="line">        &lt;property name=&quot;maxPoolSize&quot; value=&quot;5&quot;/&gt;</div><div class="line">        &lt;property name=&quot;queueCapacity&quot; value=&quot;15&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">    &lt;bean id=&quot;jsonMessageConverter&quot; class=&quot;org.springframework.amqp.support.converter.Jackson2JsonMessageConverter&quot; /&gt;</div><div class="line">    </div><div class="line">    &lt;rabbit:topic-exchange name=&quot;delayChangeTest&quot;</div><div class="line">declared-by=&quot;connectAdmin&quot; delayed=&quot;true&quot;&gt;</div><div class="line">    &lt;rabbit:bindings&gt;</div><div class="line">            &lt;rabbit:binding queue=&quot;delay_queue&quot;</div><div class="line">                    pattern=&quot;order.delay.notify&quot;</div><div class="line">            /&gt;</div><div class="line">        &lt;/rabbit:bindings&gt;</div><div class="line">    &lt;/rabbit:topic-exchange&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;!--定义queue  配置延迟队列的信息--&gt;</div><div class="line">    &lt;rabbit:queue name=&quot;delay_queue&quot;</div><div class="line">                  durable=&quot;true&quot;</div><div class="line">                  auto-declare=&quot;true&quot;</div><div class="line">                  auto-delete=&quot;false&quot;</div><div class="line">                  declared-by=&quot;connectAdmin&quot;&gt;</div><div class="line">    &lt;/rabbit:queue&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;rabbit:template id=&quot;rabbitTemplate2&quot; connection-factory=&quot;rabbitConnectionFactory&quot;</div><div class="line">                     exchange=&quot;delayChangeTest&quot;/&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;bean id=&quot;orderConsumer&quot; class=&quot;com.lidong.dubbo.core.util.customer.OrderConsumer&quot;&gt;&lt;/bean&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;rabbit:listener-container</div><div class="line">            connection-factory=&quot;rabbitConnectionFactory&quot;</div><div class="line">            acknowledge=&quot;manual&quot;</div><div class="line">            channel-transacted=&quot;false&quot;</div><div class="line">            message-converter=&quot;jsonMessageConverter&quot;&gt;</div><div class="line">        &lt;rabbit:listener queues=&quot;queueTest&quot;</div><div class="line">        ref=&quot;messageReceiver&quot;  method=&quot;onMessage&quot;/&gt;</div><div class="line">    &lt;/rabbit:listener-container&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<p>####4.3 创建生产者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">package com.lidong.dubbo.core.spittle.service;</div><div class="line"></div><div class="line">import com.lidong.dubbo.api.spittle.service.IMessageProducer;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.amqp.AmqpException;</div><div class="line">import org.springframework.amqp.core.*;</div><div class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line">import java.text.SimpleDateFormat;</div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @项目名称:lidong-dubbo</div><div class="line"> * @类名:MessageProducerImp</div><div class="line"> * @类的描述:</div><div class="line"> * @作者:lidong</div><div class="line"> * @创建时间:2017/2/4 上午10:01</div><div class="line"> * @公司:chni</div><div class="line"> * @QQ:1561281670</div><div class="line"> * @邮箱:lidong1665@163.com</div><div class="line"> */</div><div class="line">@Service</div><div class="line">public class MessageProducerServiceImp implements IMessageProducer &#123;</div><div class="line">    </div><div class="line">    </div><div class="line">    private Logger logger = LoggerFactory.getLogger(MessageProducerServiceImp.class);</div><div class="line">    @Resource</div><div class="line">    private RabbitTemplate rabbitTemplate2;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void sendMessage(Object message) &#123;</div><div class="line">        logger.info(&quot;to send message:&#123;&#125;&quot;,message);</div><div class="line">        final int xdelay= 300*1000;</div><div class="line">        SimpleDateFormat sf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</div><div class="line"></div><div class="line">        //发送延迟消息</div><div class="line">        rabbitTemplate2.convertAndSend(&quot;order.delay.notify&quot;, message,</div><div class="line">                new MessagePostProcessor() &#123;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public Message postProcessMessage(Message message)</div><div class="line">                            throws AmqpException &#123;</div><div class="line">                        //设置消息持久化</div><div class="line">                        message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);</div><div class="line">                        //设置延迟时间（5分钟后执行）</div><div class="line">                        message.getMessageProperties().setDelay(xdelay);</div><div class="line">                        logger.info(&quot;----&quot;+sf.format(new Date()) + &quot; Delay sent.&quot;);</div><div class="line"></div><div class="line">                        return message;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-4-创建消费者"><a href="#4-4-创建消费者" class="headerlink" title="4.4 创建消费者"></a>4.4 创建消费者</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">package com.lidong.dubbo.core.util.customer;</div><div class="line"></div><div class="line">import com.rabbitmq.client.Channel;</div><div class="line">import org.activiti.engine.impl.util.json.JSONObject;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.amqp.core.Message;</div><div class="line">import org.springframework.amqp.rabbit.core.ChannelAwareMessageListener;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @项目名称:lidong-dubbo</div><div class="line"> * @类名:OrderConsumer</div><div class="line"> * @类的描述:</div><div class="line"> * @作者:lidong</div><div class="line"> * @创建时间:2017/2/25 下午12:59</div><div class="line"> * @公司:chni</div><div class="line"> * @QQ:1561281670</div><div class="line"> * @邮箱:lidong1665@163.com</div><div class="line"> */</div><div class="line">public class OrderConsumer implements ChannelAwareMessageListener &#123;</div><div class="line">    private Logger logger = LoggerFactory.getLogger(OrderConsumer.class);</div><div class="line">    @Override</div><div class="line">    public void onMessage(Message message, Channel channel) throws Exception &#123;</div><div class="line"></div><div class="line">        logger.info(&quot;[延时消息]&quot; + message.getMessageProperties());</div><div class="line">        if (message != null) &#123;</div><div class="line">            long deliveryTag = message.getMessageProperties().getDeliveryTag();</div><div class="line">            logger.debug(&quot;deliveryTag= &quot;+deliveryTag);</div><div class="line">            //手动确认</div><div class="line">            channel.basicAck(deliveryTag,false);</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发送消息之后。消费5分钟之后接受到消息，开始处理。</p>
<p><a href="https://github.com/lidong1665/dubbo2.5-spring4-mybastis3.2-springmvc4-mongodb-redis" target="_blank" rel="external">代码地址</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://avatar.csdn.net/E/A/D/1_u010046908.jpg"
               alt="李东" />
          <p class="site-author-name" itemprop="name">李东</p>
          <p class="site-description motion-element" itemprop="description">细节决定成败，点滴铸就辉煌</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李东</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "95b2cee436ec4d489b6e0797b46a68d2",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  






  
  

  

  

  

  


</body>
</html>
